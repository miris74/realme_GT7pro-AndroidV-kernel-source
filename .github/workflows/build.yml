name: Build Kernel - The Final One

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Set Build Environment
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "KBUILD_BUILD_USER=GitHubActions" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=GitHub" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV

      # 7. カーネルのビルド
      - name: Build Kernel
        run: |
          cd $GITHUB_WORKSPACE
          make mrproper
          make O=out oplus_debug_defconfig
          make O=out defconfig
          echo "CONFIG_KSU=y" >> out/.config
          echo "CONFIG_SUSFS=y" >> out/.config
          make O=out -j$(nproc --all)
          path: out/arch/arm64/boot/Image
          
          # KernelSUとsusfsを有効化
          echo "CONFIG_KSU=y" >> kernel/out/.config
          echo "CONFIG_SUSFS=y" >> kernel/out/.config
          
          # ビルドを実行
          make O=out -j$(nproc --all)

      # 8. 完成したカーネルイメージをアップロード
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: kernel/out/arch/arm64/boot/Image
